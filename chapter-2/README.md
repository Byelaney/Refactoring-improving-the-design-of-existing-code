# Chapter 2 重构的法则


上一章节的例子应该大体上让你明白了什么是重构。现在是时候让我们来回顾一下关于重构的那些法则了。

## 定义什么是重构

就像其他软件开发的术语一样，“重构”这个词也经常会被不准确地使用。“重构”可以被用作名词和动词，定义如下：

> **Refactoring (noun)**: 是对软件内部结构的一种改变，这种改变可以使代码更容易被理解和更改，并且不能改变软件对外的行为。

> **Refactoring (verb)**:对软件进行一系列的重构（名词），并且不改变软件对外的行为。

在过去的几十年间，许多业界人员都会错误地使用“重构”这个词，他们认为任何对代码的清理都能被称为是“重构”。事实上重构是由一系列小的重构组成的，重要的是每次你的重构都足够的小，因为足够小，所以你的软件还是能够正常运行并且很容易进行，这些小的步骤最后会成为一个大的重构，

> 如果有人和你说他把代码重构坏了，那么你应该很确定他不是在重构。

我使用 “restructuring” 这个词来指代对 code base 的任何 reorganizing 或者 cleaning up ，并且把重构看作是 “restructuring” 的一种。第一次见我重构的人可能会认为这样效率很低，我进行很多很小的步骤来重构，而不是一次性修改很大一部分。但最终正是这些小步骤让我能够更快地进行下去，因为我根本不用花费很多时间去 debugging。

在我的定义里，我提到了“软件对外的行为”，这里的意思简单来说就是在重构完之后程序应该和重构完之前有一样的功能。并不是说程序内部运行和重构之前一模一样，比如调用栈，性能等等。这里的功能应该是指用户所真正关心的功能。

重构和性能优化非常相似，因为它们都不应该改变程序的功能。区别在于彼此的目的：重构总是为了“使代码更容易被理解和更改”，这可能使程序变慢但也可能变快。对性能优化而言，我只考虑怎么使程序变快，有时不可避免的会需要难以理解的代码。

## 两顶帽子

Kent Beck 对此有一个 two hats 的比喻。当你使用重构来开发软件的时候，你把时间分配在两个不同的方面：增加新功能和重构。当我增加新功能的时候，我不应该改变原有的代码；我只是在增加新的功能。我通过增加新的测试来衡量我的工作进程。当我重构的时候，我不应该增加新的功能；我只是在 restructure 我的代码。我不用增加任何的测试（除非我发现之前有遗漏）。

当我自己开发软件的时候，我发现我经常换着戴这两顶“帽子”。我刚开始是想增加新的功能，但有时候会发现如果我重新组织代码，会更容易达到我增加新功能的目的。所以我换帽子到“重构”了。一旦代码有了更好的组织结构，我再换帽子到“增加功能”，并且增加功能。一旦新功能增加好了，我可能又意识到我写的代码实在太难理解了，所以我又换帽子并且重构并且重构。整个过程可能只有十分钟，但是我总是有意识的知道我在干什么。

## 为什么要重构？

我不会说“重构可以解决软件的所有问题”，它不是 “silver bullet”（银弹）。但它是一种珍贵的控制代码的工具，并且可以或者说应该被广泛使用。

## 重构提高软件的设计

如果没有重构，软件的结构会有衰变的倾向。随着开发者为了各种短期目的改变代码（常常没有很好的理解架构），代码会渐渐地失去原有的结构，并且这会有一种累积的效果，代码越是难读懂，开发者越是会乱改，于是代码的结构衰变的越快。定期的重构有助于维护代码的结构。

设计不良的代码通常会需要更多的代码来做同一件事，经常是因为在很多地方散落了重复的代码。因此改善设计的一个重要方面就是要避免重复代码。并不是因为减少了代码数量系统会变得那么的快而重要，减少重复代码会对你以后改变代码起巨大的作用。代码越多，越是难正确地去修改，因为你要理解更多的代码。我在一个地方修改了代码，但是系统并没有按我理解的去运行，这是因为在另一个地方也有同样的代码但我却没有修改。通过避免重复代码，我能够保证某部分代码 `says everything once and only once`，这正是良好设计的核心。

## 重构使软件更容易被理解

编程从许多意义上来说，其实是一种和计算机进行的沟通。我们写代码来告诉计算机该做什么，然后计算机准确地去做，不会多做也不会少。我们及时地减少我想让计算机做什么和我告诉计算机做什么之间的差距，编程其实就是关于如何准确地把我想做的事传达给计算机。但很有可能我们的代码会被其他用户使用，或许几个月后，另一个开发者会尝试着去阅读我的代码，并做一些他需要的变化。我们经常忽视了别人可能会阅读并修改我们的代码，而这恰恰是最重要的。就算计算机要多进行几个时钟循环来编译那又怎么样呢？但如果你的代码需要另一个程序员花几周甚至几个月才能正确理解，那就真的很重要了。

问题在于当我们自己编程的时候，我们只想要实现好我们的需求，而根本不会去想未来的那个开发者。重构帮助我们使得代码可读性更强。在重构之前，我们的代码可以工作但没有很好的结构。花那么一点时间来重构可以使我们的代码更好的阐明我们真正的意图。

我并不是无私的为其他开发者来重构，其实很多情况下那个其他开发者正是我们自己。所以这就使得重构更加重要了。我个人是非常懒非常健忘的，我健忘的一个形式就是我从来不记得我之前写过的代码。事实上我刻意地不去记以前写过的代码，因为我怕我的小脑袋会爆炸。我把我要记的所有东西都放在了重构好的代码里，那样我可以少担心点我的脑细胞。

## 重构利于我发现 Bug

有助于理解代码也就同时意味着有助于发现 bug。我必须承认我不是一个特别善于发现 bug 的程序员。有的天才可以通过读一大段复杂的代码并发现其中的 bug，而我却办不到。然而我有自己的办法，我发现如果我重构代码，我会试着去很深入地了解我的代码，并且把这种理解又体现在重构的代码里。通过使程序的结构变得更加清晰，甚至是我都能发现之前根本发现不了的 bug！

这让我想起了 Kent Beck 经常提起的关于自己的一句话：“我不是个伟大的程序员，我只是个还不错的程序员多加了点伟大的习惯而已。”重构帮助我更有效地书写健壮的代码。
